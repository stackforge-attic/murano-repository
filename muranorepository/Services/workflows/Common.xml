<workflow>

	<rule match="$.services[*].units[?(@.state.hostname is None)]" desc="Units with no hostname">
		<set path="state.hostname">
			<generate-hostname>
				<parameter name="pattern"><select path="::unitNamingPattern"/></parameter>
				<parameter name="service_id"><select path="::id"/></parameter>
			</generate-hostname>
		</set>
	</rule>

	<rule match="$[?(not @.state.deleted)]" desc="Search through all the environments..">
		<rule match="$.services[*].units[*]" desc="If any units exists" limit="1">
			<mute/>
            <empty>
				<delete-cf-stack>
					<success>
						<set path="/state.deleted"><true/></set>
					</success>
				</delete-cf-stack>
			</empty>
		</rule>
	</rule>

    <rule match="$[?(@.networking.state.ready_for_cf)].services[?(@.type in ('webServer', 'aspNetApp') and @.assignFloatingIP)].units[?(not @.temp.floatingIpAssigned)]"
          desc="Units of non-farms services which have no floating assigned yet">
        <report entity="unit">
			<parameter name="id"><select path="id"/></parameter>
			<parameter name="text">Floating IP is assigned to the application</parameter>
		</report>
		<update-cf-stack template="FloatingIPwithoutLB" error="exception">
			<parameter name="mappings">
				<map>
                    <mapping name="instanceName"><select path="state.hostname"/></mapping>
                    <mapping name="externalNetworkId"><select path="/networking.floatingId"/></mapping>
                    <mapping name="instancePort">port-<select path="state.hostname"/></mapping>
				</map>
			</parameter>
			<success>
				<set path="temp.floatingIpAssigned"><true/></set>
                <set path="::floating-ip"><select source="outputs"><select path="state.hostname"/>-FloatingIPaddress</select></set>
				<report entity="unit">
					<parameter name="id"><select path="id"/></parameter>
					<parameter name="text">Floating IP has been assigned to  <select path="state.hostname"/></parameter>
				</report>
			</success>
            <failure>
                <report entity="unit" level="error">
					<parameter name="id"><select path="id"/></parameter>
					<parameter name="text">Unable to assign floating IP to instance <select path="state.hostname"/> (<select path="name"/>) due to <format-error error="exception"/></parameter>
				</report>
                <stop/>
            </failure>
		</update-cf-stack>
    </rule>

</workflow>
